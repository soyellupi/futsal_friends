# Database Migrations

This document explains how to manage database migrations using Alembic.

## Overview

We use **Alembic** for database schema versioning and migrations. Alembic tracks changes to the database schema over time and provides tools to upgrade or downgrade between versions.

## Configuration

**Alembic Configuration**: `/backend/alembic.ini`
**Migration Scripts**: `/backend/alembic/versions/`
**Environment**: `/backend/alembic/env.py`

The configuration automatically:
- Reads database URL from `app/config.py`
- Imports all models from `app/models/`
- Supports autogenerate for detecting model changes

## Common Operations

### 1. Create a New Migration

After modifying models, generate a migration:

```bash
cd backend
alembic revision --autogenerate -m "Description of changes"
```

Example:
```bash
alembic revision --autogenerate -m "Add player avatar field"
```

This will:
1. Compare current database schema with models
2. Generate a migration script in `alembic/versions/`
3. Include detected changes (new tables, columns, indexes, etc.)

### 2. Review Generated Migration

**Always review** the generated migration before applying:

```bash
cat alembic/versions/2025_11_01_xxxx_description.py
```

Check for:
- Correct table and column names
- Proper data types
- Foreign key relationships
- Indexes and constraints
- Data migrations (if needed)

### 3. Apply Migrations

Apply all pending migrations:

```bash
alembic upgrade head
```

Apply specific number of migrations:

```bash
alembic upgrade +1  # Apply one migration
alembic upgrade +2  # Apply two migrations
```

Apply to specific revision:

```bash
alembic upgrade <revision_id>
```

### 4. Rollback Migrations

Rollback one migration:

```bash
alembic downgrade -1
```

Rollback to specific revision:

```bash
alembic downgrade <revision_id>
```

Rollback all migrations:

```bash
alembic downgrade base
```

### 5. View Migration History

Show current version:

```bash
alembic current
```

Show migration history:

```bash
alembic history
```

Show verbose history with details:

```bash
alembic history --verbose
```

### 6. Create Empty Migration

For data migrations or custom changes:

```bash
alembic revision -m "Custom data migration"
```

This creates an empty migration you can edit manually.

## Migration Best Practices

### 1. Always Review Autogenerated Migrations

Alembic's autogenerate is smart but not perfect:

```python
# Review these carefully:
- Renamed columns (may appear as drop + add)
- Changed column types
- Foreign key relationships
- Indexes (may miss some)
```

### 2. Test Migrations

Before deploying:

```bash
# Test upgrade
alembic upgrade head

# Test downgrade
alembic downgrade -1

# Test upgrade again
alembic upgrade head
```

### 3. Handle Data Migrations

For data migrations, use the `op.execute()` function:

```python
def upgrade():
    # Schema change
    op.add_column('players', sa.Column('email', sa.String(255)))

    # Data migration
    op.execute(
        """
        UPDATE players
        SET email = CONCAT(LOWER(name), '@example.com')
        WHERE email IS NULL
        """
    )

    # Make column non-nullable
    op.alter_column('players', 'email', nullable=False)
```

### 4. Large Table Migrations

For large tables, consider:

```python
# Add column as nullable first
op.add_column('players', sa.Column('rating', sa.Float(), nullable=True))

# Populate data in batches (outside migration)
# Then make non-nullable in separate migration
```

### 5. Backup Before Migration

Always backup production data:

```bash
pg_dump futsal_friends_db > backup_$(date +%Y%m%d_%H%M%S).sql
```

## Migration Structure

### Example Migration File

```python
"""Add player email field

Revision ID: abc123def456
Revises: previous_revision
Create Date: 2025-11-01 21:14:52.123456
"""
from alembic import op
import sqlalchemy as sa

# revision identifiers
revision = 'abc123def456'
down_revision = 'previous_revision'
branch_labels = None
depends_on = None

def upgrade():
    """Apply changes"""
    op.add_column('players',
        sa.Column('email', sa.String(255), nullable=True)
    )
    op.create_index('ix_players_email', 'players', ['email'])

def downgrade():
    """Revert changes"""
    op.drop_index('ix_players_email', 'players')
    op.drop_column('players', 'email')
```

## Common Migration Patterns

### Add Column

```python
def upgrade():
    op.add_column('table_name',
        sa.Column('column_name', sa.String(100), nullable=True)
    )

def downgrade():
    op.drop_column('table_name', 'column_name')
```

### Add Index

```python
def upgrade():
    op.create_index('ix_table_column', 'table_name', ['column_name'])

def downgrade():
    op.drop_index('ix_table_column', 'table_name')
```

### Add Foreign Key

```python
def upgrade():
    op.add_column('child_table',
        sa.Column('parent_id', sa.UUID(), nullable=True)
    )
    op.create_foreign_key(
        'fk_child_parent',
        'child_table', 'parent_table',
        ['parent_id'], ['id'],
        ondelete='CASCADE'
    )

def downgrade():
    op.drop_constraint('fk_child_parent', 'child_table')
    op.drop_column('child_table', 'parent_id')
```

### Rename Column

```python
def upgrade():
    op.alter_column('table_name',
        'old_name',
        new_column_name='new_name'
    )

def downgrade():
    op.alter_column('table_name',
        'new_name',
        new_column_name='old_name'
    )
```

### Change Column Type

```python
def upgrade():
    # PostgreSQL specific
    op.execute(
        'ALTER TABLE table_name '
        'ALTER COLUMN column_name TYPE INTEGER USING column_name::integer'
    )

def downgrade():
    op.execute(
        'ALTER TABLE table_name '
        'ALTER COLUMN column_name TYPE VARCHAR(50)'
    )
```

### Add Enum Type

```python
from sqlalchemy.dialects.postgresql import ENUM

def upgrade():
    # Create enum type
    status_enum = ENUM('active', 'inactive', 'pending',
                      name='status_type', create_type=True)
    status_enum.create(op.get_bind(), checkfirst=True)

    # Add column
    op.add_column('table_name',
        sa.Column('status', status_enum, nullable=False)
    )

def downgrade():
    op.drop_column('table_name', 'status')
    # Drop enum type
    ENUM(name='status_type').drop(op.get_bind(), checkfirst=True)
```

### Add Value to Existing Enum

```python
def upgrade():
    # Add new value to existing enum (PostgreSQL)
    op.execute("ALTER TYPE match_status ADD VALUE 'unplayable'")

def downgrade():
    # Note: PostgreSQL doesn't support removing enum values directly
    # Would require recreating the enum type and updating all references
    pass
```

## Troubleshooting

### Migration Won't Apply

```bash
# Check current version
alembic current

# Check if ahead of database
alembic history

# Stamp database to specific version (use carefully!)
alembic stamp <revision_id>
```

### Autogenerate Misses Changes

If autogenerate doesn't detect changes:

```python
# 1. Check models are imported in alembic/env.py
from app.models import *

# 2. Check Base.metadata is set correctly
target_metadata = Base.metadata

# 3. Manually create migration
alembic revision -m "Manual migration"
```

### Migration Conflicts

If working in a team:

```bash
# Pull latest migrations
git pull

# Check for conflicts
alembic heads  # Should show one head

# If multiple heads, merge them
alembic merge <head1> <head2> -m "Merge migrations"
```

### Database Out of Sync

If database state doesn't match migrations:

```bash
# Option 1: Rollback and reapply
alembic downgrade base
alembic upgrade head

# Option 2: Drop and recreate (DEVELOPMENT ONLY!)
# In PostgreSQL:
DROP SCHEMA public CASCADE;
CREATE SCHEMA public;
alembic upgrade head
```

## Production Migration Workflow

### 1. Development

```bash
# Make model changes
# Generate migration
alembic revision --autogenerate -m "Add feature X"

# Review and test
alembic upgrade head
alembic downgrade -1
alembic upgrade head

# Commit migration
git add alembic/versions/xxxx_add_feature_x.py
git commit -m "Add feature X migration"
```

### 2. Staging

```bash
# Pull latest code
git pull

# Backup database
pg_dump staging_db > backup_staging.sql

# Apply migrations
alembic upgrade head

# Test application
pytest
```

### 3. Production

```bash
# Backup database
pg_dump production_db > backup_prod_$(date +%Y%m%d).sql

# Enable maintenance mode (if applicable)

# Apply migrations
alembic upgrade head

# Verify
alembic current

# Test application

# Disable maintenance mode
```

## Initial Migration

The initial migration (revision `0a8702210b54`) created all 10 tables:

```bash
# Migration: 2025_11_01_2114-0a8702210b54_initial_database_schema_with_all_tables.py
```

**Created Tables:**
1. players
2. seasons
3. player_season_ratings
4. matches
5. match_attendances
6. third_time_attendances
7. teams
8. team_players
9. match_results
10. player_match_ratings

**With:**
- All foreign keys
- Indexes for performance
- Check constraints for data integrity
- Unique constraints
- Enum types

## See Also

- [Database Schema](schema.md) - Complete schema documentation
- [SQLAlchemy Models](models.md) - Model definitions
- [Alembic Documentation](https://alembic.sqlalchemy.org/)
